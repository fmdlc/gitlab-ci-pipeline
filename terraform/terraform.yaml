##----------------------------------------------
## Terraform pipeline
##----------------------------------------------
---
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == null || $CI_COMMIT_BRANCH == ""'
      when: never
    - when: always

.terraform-plan:
  image: docker.io/hashicorp/terraform:1.0.7
  allow_failure: false
  stage: terraform-plan
  resource_group: "${ENV}"
  before_script:
    - rm -rf ${TF_ROOT}/.terraform
    - rm -rf ${TF_ROOT}/.terraform.lock.hcl
    - mkdir /root/.terraform.d/ 
  script:
    - base64 -d $TF_CONFIG > /root/.terraform.d/credentials.tfrc.json
    - terraform init -backend=true -backend-config=./vars/$ENV/backend.tf
    - terraform validate
    - terraform plan -out=state.plan -var-file=./vars/$ENV/terraform.tfvars
  artifacts:
    expire_in: 2 hours
    paths: 
      - .terraform
      - .teraform.lock.hcl
      - state.plan

.terraform-apply:
  image: docker.io/hashicorp/terraform:1.0.7
  allow_failure: false
  stage: terraform-apply
  before_script:
    - mkdir /root/.terraform.d/ 
  script:
    - base64 -d $TF_CONFIG > /root/.terraform.d/credentials.tfrc.json
    - terraform apply -auto-approve "state.plan"
  when: manual
