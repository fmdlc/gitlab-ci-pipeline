##----------------------------------------------
## Terraform pipeline
##----------------------------------------------
---
.terraform-init:
  image: docker.io/hashicorp/terraform:1.0.7
  allow_failure: false
  stage: terraform-init
  artifacts:
    paths:
      - .terraform
      - /root/.terraform.d/credentials.tfrc.jso
  before_script:
    - rm -rf .terraform
    - mkdir /root/.terraform.d/
    - base64 -d $TF_CONFIG > /root/.terraform.d/credentials.tfrc.json
    - terraform login
  script:
    - terraform init -backend-config=./vars/$ENV/backend.tf

.terraform-plan:
  image: docker.io/hashicorp/terraform:1.0.7
  allow_failure: false
  stage: terraform-plan
  artifacts:
    paths:
      - state-$CI_JOB_ID.plan
  script:
    - terraform plan -out=state-$CI_JOB_ID.plan -var-file=./vars/$ENV/terraform.tfvars

.terraform-apply:
  image: docker.io/hashicorp/terraform:1.0.7
  allow_failure: false
  stage: terraform-apply
  script:
    - terraform apply -auto-approve "state-$CI_JOB_ID.plan"
