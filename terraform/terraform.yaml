##----------------------------------------------
## Terraform pipeline
##----------------------------------------------
---
variables:
  ENV: $ENVIRONMENT
  PROJECT_NAME: ${CI_PROJECT_NAME}

.terraform-init:
  image: $TF_IMAGE
  allow_failure: true
  stage: terraform-init
  artifacts:
    paths:
      - .terraform
  script:
    - terraform init

.terraform-plan:
  image: $TF_IMAGE
  allow_failure: false
  stage: terraform-plan
  artifacts:
    path:
      - state.plan
  script:
    - terraform plan -out=state.plan

.terraform-apply:
  image: $TF_IMAGE
  allow_failure: false
  stage: terraform-apply
  script:
    - terraform apply -auto-approve "state.plan"
